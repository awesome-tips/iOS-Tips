# 2017.01

## ç›®å½•

* [1.Swiftä¸­lazyä½œæƒ°æ€§æ±‚å€¼](#1.Swiftä¸­lazyä½œæƒ°æ€§æ±‚å€¼)
* [2.Swiftçš„strideæ“ä½œ](#2.Swiftçš„strideæ“ä½œ)
* [3.staticæ–¹æ³•ä¸classæ–¹æ³•çš„åŒºåˆ«](#3.staticæ–¹æ³•ä¸classæ–¹æ³•çš„åŒºåˆ«)
* [4.Swiftä¸­çš„å‡½æ•°å€¼](#4.Swiftä¸­çš„å‡½æ•°å€¼)
* [5.Array.containsæ“ä½œ](#5.Array.containsæ“ä½œ)
* [6.NSRecursiveLocké€’å½’é”çš„ä½¿ç”¨](#6.NSRecursiveLocké€’å½’é”çš„ä½¿ç”¨)
* [7.__attribute__((noescape))å±æ€§](#7.__attribute__((noescape))å±æ€§)
* [8.Swiftä¸­çš„escaping_closure](#8.Swiftä¸­çš„escaping_closure)
* [Traits](#Traits)
* [10.Injectionä»£ç æ³¨å…¥](#10.Injectionä»£ç æ³¨å…¥)
* [11.è·¯å¾„å¡«å……è§„åˆ™](#11.è·¯å¾„å¡«å……è§„åˆ™)
* [12.filterä¸flatMapè¿‡æ»¤nil](#12.filterä¸flatMapè¿‡æ»¤nil)
* [13.NSRecursiveLock.lock(before:)](#13.NSRecursiveLock.lock(before:))
* [14.Swift3ç§»é™¤Optionalç±»å‹çš„æ¯”è¾ƒæ“ä½œ](#14.Swift3ç§»é™¤Optionalç±»å‹çš„æ¯”è¾ƒæ“ä½œ)
* [15.__attribute__((objc_requires_super))](#15.__attribute__((objc_requires_super)))
* [16.__attribute__((objc_runtime_name))](#16.__attribute__((objc_runtime_name)))
* [17.Tagged_Pointer](#17.Tagged_Pointer)
* [18.Extension_Selector](#18.Extension_Selector)
* [19.typealiasæ³›å‹é—­åŒ…](#19.typealiasæ³›å‹é—­åŒ…)
* [20.Swift3çš„#keyPath](#20.Swift3çš„#keyPath)
* [21.Swift3ç§»é™¤varå…³é”®å­—](#21.Swift3ç§»é™¤varå…³é”®å­—)
* [22.Swift3ä¸­çš„AnyHashable](#22.Swift3ä¸­çš„AnyHashable)

1.Swiftä¸­lazyä½œæƒ°æ€§æ±‚å€¼
------------------

å‡½æ•°å¼ç¼–ç¨‹ä¸­æœ‰æƒ°æ€§æ±‚å€¼çš„æ¦‚å¿µï¼Œå³ä¸€æ¬¡è®¡ç®—åœ¨çœŸæ­£éœ€è¦æ—¶æ‰æ‰§è¡Œï¼Œå°½å¯èƒ½æ¨è¿Ÿæ±‚è§£è¡¨è¾¾å¼ã€‚

å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬å¯¹æ¯ä¸ªå…ƒç´ ä½œ`element*2`çš„mapæ“ä½œï¼Œè·å–å…¶ä¸­æŸä¸€ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬ä¼šå¦‚ä¸‹ä»£ç å¤„ç†:

```swift
let array = [1, 2, 4, 5, 3, 7]
let element = array.map{ $0 * 2 }[3]
print(element)
```

è¿™ä¸ªè®¡ç®—å¯¹æ¯ä¸ªå…ƒç´ éƒ½*2ï¼Œæœ€åæˆ‘ä»¬åªå–äº†å…¶ä¸­ä¸€ä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿™ä¸ªåœºæ™¯ä¸­å¦å¤–5æ¬¡è®¡ç®—æ˜¯æ— æ„ä¹‰çš„ã€‚

è¿™æ—¶ä½¿ç”¨æƒ°æ€§æ±‚å€¼å°±å¯ä»¥é¿å…è¿™ç®—æµªè´¹ã€‚æˆ‘ä»¬çŸ¥é“Swiftä¸­æœ‰ä¸ªlazyå…³é”®å­—ï¼Œå¦‚æœç”¨æ¥ä¿®é¥°å±æ€§ä¹‹ç±»çš„ï¼Œå¯ä»¥å®ç°å±æ€§çš„æƒ°æ€§æ±‚å€¼ã€‚åŒæ ·ï¼ŒSwiftæ‰©å±•äº†LazySequenceProtocolåè®®ï¼Œæä¾›äº†ä¸€ä¸ªlazyå±æ€§ï¼Œç”¨äºå¤„ç†mapï¼Œfilterç­‰æ“ä½œçš„æƒ°æ€§æ±‚å€¼ï¼Œå®šä¹‰å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
/// Avoid creating multiple layers of `LazySequence` wrapper.
/// Anything conforming to `LazySequenceProtocol` is already lazy.
extension LazySequenceProtocol {

    /// Identical to `self`.
    public var lazy: Self { get }
}
```

æ‰€ä»¥ï¼Œä¸Šé¢è¿™ä¸ªä¾‹å­å¦‚æœè¦å®ç°æƒ°æ€§æ±‚å€¼ï¼Œåˆ™å¯ä»¥å¦‚ä¸‹ä»£ç å¤„ç†ï¼š

```swift
let array = [1, 2, 4, 5, 3, 7]
let element = array.lazy.map{ $0 * 2 }[3]
print(element)
```

æˆ‘ä»¬åœ¨Playgroundä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªè®¡ç®—ä¸­å®é™…åªæ‰§è¡Œäº†ä¸€æ¬¡*2æ“ä½œã€‚

2.Swiftçš„strideæ“ä½œ
----------

åœ¨Swiftä¸­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åˆ›å»ºä¸€ä¸ªä¸€å®šæ­¥é•¿çš„æ•°ç»„ï¼Œå¯ä»¥å¦‚ä¸‹ä»£ç æ“ä½œï¼š

```swift
var array: [Double] = []
for value in 0..<10 {
    array.append(Double(value) * 0.3)
}
```

ä¸è¿‡å¦‚æœæƒ³åœ¨æŸä¸ªåŒºé—´åˆ›å»ºè¿™æ ·ä¸€ä¸ªåºåˆ—çš„è¯ï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ã€‚ä¸ºæ­¤ï¼ŒSwiftæä¾›äº†ä¸€ä¸ªä¾¿æ·å‡½æ•°ï¼š`stride`ï¼Œå¯ä»¥åœ¨æŸä¸ªåŒºé—´å†…åˆ›å»ºä¸€ä¸ªä»»æ„å¯å˜æ­¥é•¿çš„åºåˆ—ï¼Œè¿™ä¸ªæ­¥é•¿å¯ä»¥æ˜¯ä»»æ„å€¼ã€‚æ‰€ä»¥ä¸Šé¢è¿™ä¸ªé—®é¢˜çš„å®ç°å¯ä»¥å¦‚ä¸‹ä»£ç å¤„ç†ï¼š

```swift
let array = stride(from: 0, to: 3, by: 0.3).map {
    $0
}
```

å®é™…ä¸Šï¼Œ`stride`çš„äº§ç”Ÿçš„åºåˆ—å¦‚ä¸‹ä»£ç ï¼š

`start, start + stride, start + 2 * stride, â€¦, start + n * stride`

`stride`æœ‰ä¸¤ä¸ªå˜ç§ï¼š

1. `stride(from:to:by)`ï¼Œå¼€åŒºé—´å¤„ç†ï¼Œæœ€åä¸€ä¸ªå€¼ä¸¥æ ¼å°äºæœ€å¤§å€¼ï¼›
2. `stride(from:through:by)`ï¼Œé—­åŒºé—´å¤„ç†ï¼Œæœ€åä¸€ä¸ªå€¼å°äºæˆ–ç­‰äºæœ€å¤§å€¼

`stride`å‡½æ•°ä¸`map`é…åˆèµ·æ¥å¯ä»¥åšä¸€äº›æœ‰æ„æ€çš„äº‹æƒ…ã€‚

3.staticæ–¹æ³•ä¸classæ–¹æ³•çš„åŒºåˆ«
----------

åœ¨Swiftä¸­ï¼Œ`static`å’Œ`class`è¿™ä¸¤ä¸ªå…³é”®å­—éƒ½å¯ä»¥ä¿®é¥°ç±»çš„æ–¹æ³•ï¼Œä»¥è¡¨æ˜è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªç±»æ–¹æ³•ã€‚ä¸è¿‡è¿™ä¸¤è€…ç¨å¾®æœ‰ä¸€äº›åŒºåˆ«ï¼š`class`ä¿®é¥°çš„ç±»æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™ï¼Œè€Œ`static`ä¿®é¥°çš„ç±»æ–¹æ³•åˆ™ä¸èƒ½ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
class A {
    
    class func method1() {
        print("A.method1");
    }
    
    static func method2() {
        print("A.method2");
    }
}

class B : A {
    
    override class func method1() {
        print("B.method1");
    }
    
    override static func method2() {	// Error: Cannot override static method
        print("B.method2");
    }
}

B.method1()
B.method2()
```

4.Swiftä¸­çš„å‡½æ•°å€¼
----------

æˆ‘ä»¬çŸ¥é“åœ¨Swiftä¸­ï¼Œå‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œå³å‡½æ•°ä¹Ÿæ˜¯ä¸€ç§ç±»å‹ï¼Œå¯å……å½“å‚æ•°ã€è¿”å›å€¼ç­‰è§’è‰²ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å®šä¹‰å‡½æ•°ç±»å‹çš„å¸¸é‡/å˜é‡ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹å¯ä»¥ç®€åŒ–æˆ‘ä»¬çš„ä»£ç ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
let setInt: (Int, String) -> Void = UserDefaults.standard.set
let getInt: (String) -> Int = UserDefaults.standard.integer

setInt(10, "key")
print(getInt("key"))
```

5.Array.containsæ“ä½œ
----------

Swiftä¸­åˆ¤æ–­ä¸€ä¸ª`Array`ä¸­æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`contains`æ–¹æ³•ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
let array = [2, 5, 6, 7, 19, 40]

array.contains(10)				// false
```

ä¸è¿‡è¿™ä¸ªæ–¹æ³•è¦æ±‚æ•°ç»„ä¸­çš„å…ƒç´ ç±»å‹å®ç°äº†`Equatable`åè®®ï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
enum Animal {
    case dog
    case cat(Int)
}

let animals: [Animal] = [.dog, .dog]
let hasCat = animals.contains(.cat(100))	// ç¼–è¯‘å™¨é”™è¯¯
```

è¿˜å¥½Swiftä¸ºæˆ‘ä»¬æä¾›äº†å¦ä¸€ä¸ª`contains`æ–¹æ³•ï¼Œå¯ä»¥è‡ªå®šä¹‰è°“è¯æ¡ä»¶ä½œä¸ºåˆ¤æ–­ä¾æ®ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```swift
public func contains(where predicate: (Element) throws -> Bool) rethrows -> Bool
```

è¿™ä¸ªæ–¹æ³•ä¼šæŸ¥çœ‹æ•°ç»„æ˜¯å¦åŒ…å«æ»¡è¶³ç»™å®šçš„è°“è¯æ¡ä»¶çš„å…ƒç´ ã€‚å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ªå°¾éšé—­åŒ…ï¼Œåœ¨é—­åŒ…å†…æˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…éœ€è¦æ¥å®ç°æˆ‘ä»¬è‡ªå·±çš„åˆ¤æ–­ã€‚æ‰€ä»¥ä¸Šé¢çš„åˆ¤æ–­å¯ä»¥å¦‚ä¸‹ä»£ç å®ç°ï¼š

```swift
enum Animal {
    case dog
    case cat(Int)
}

let animals: [Animal] = [.dog, .dog]
let hasCat = animals.contains { animal in
    
    if case .cat = animal {
        return true
    } else {
        return false
    }
}
```

å½“ç„¶ï¼Œå¯¹äºå…ƒç´ ç±»å‹å®ç°äº†`Equatable`åè®®çš„æ•°ç»„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚å¯ä»¥è‡ªå®šä¹‰è°“è¯æ¡ä»¶ï¼ŒæŸ¥çœ‹æ•°ç»„æ˜¯å¦æœ‰æ»¡è¶³æ­¤æ¡ä»¶çš„å…ƒç´ ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
let array = [2, 5, 6, 7, 19, 40]

array.contains { (element) -> Bool in
    element % 7 == 0
}
```

6.NSRecursiveLocké€’å½’é”çš„ä½¿ç”¨
----------

`NSRecursiveLock`å®šä¹‰çš„æ˜¯ä¸€ä¸ªé€’å½’é”ï¼Œè¿™ä¸ªé”å¯ä»¥è¢«åŒä¸€çº¿ç¨‹å¤šæ¬¡è¯·æ±‚ï¼Œè€Œä¸ä¼šå¼•èµ·æ­»é”ã€‚å®ƒä¸»è¦æ˜¯ç”¨åœ¨å¾ªç¯æˆ–é€’å½’æ“ä½œä¸­ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹é¢ä»£ç ç¤ºä¾‹ï¼š

```swift
let lock = NSLock()
var recursiveMethod: ((Int) -> Void)! = nil
   
recursiveMethod = { value in
  
  defer {
      lock.unlock()
  }
  
  lock.lock()
  
  guard value > 0 else {
      return
  }
  
  print(value)
  sleep(2)
  recursiveMethod(value - 1)
}
   
DispatchQueue.global().async {
  
  print("start")
  recursiveMethod(5)
  print("end")
}
```

è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªå…¸å‹çš„æ­»é”æƒ…å†µã€‚åœ¨æˆ‘ä»¬çš„çº¿ç¨‹ä¸­ï¼Œ`RecursiveMethod`æ˜¯é€’å½’è°ƒç”¨çš„ã€‚æ‰€ä»¥æ¯æ¬¡è¿›å…¥è¿™ä¸ªé—­åŒ…å‡½æ•°æ—¶ï¼Œéƒ½ä¼šå»åŠ ä¸€æ¬¡é”ï¼Œè€Œä»ç¬¬äºŒæ¬¡å¼€å§‹ï¼Œç”±äºé”å·²ç»è¢«ä½¿ç”¨äº†ä¸”æ²¡æœ‰è§£é”ï¼Œæ‰€ä»¥å®ƒéœ€è¦ç­‰å¾…é”è¢«è§£é™¤ï¼Œè¿™æ ·å°±å¯¼è‡´äº†æ­»é”ï¼Œçº¿ç¨‹è¢«é˜»å¡ä½äº†ã€‚è°ƒè¯•å™¨ä¸­ä¼šè¾“å‡ºä¿¡æ¯å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
start
5
2017-01-07 12:48:26.580 Test111[3633:116345] *** -[NSLock lock]: deadlock (<NSLock: 0x6080000c4750> '(null)')
2017-01-07 12:48:26.581 Test111[3633:116345] *** Break on _NSLockError() to debug.
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨`NSRecursiveLock`ã€‚å®ƒå¯ä»¥å…è®¸åŒä¸€çº¿ç¨‹å¤šæ¬¡åŠ é”ï¼Œè€Œä¸ä¼šé€ æˆæ­»é”ã€‚é€’å½’é”ä¼šè·Ÿè¸ªå®ƒè¢«`lock`çš„æ¬¡æ•°ã€‚æ¯æ¬¡æˆåŠŸçš„`lock`éƒ½å¿…é¡»å¹³è¡¡è°ƒç”¨`unlock`æ“ä½œã€‚åªæœ‰è¾¾åˆ°è¿™ç§å¹³è¡¡ï¼Œé”æœ€åæ‰èƒ½è¢«é‡Šæ”¾ï¼Œä»¥ä¾›å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ã€‚

æ‰€ä»¥ï¼Œä½¿ç”¨`NSRecursiveLock`å¯¹å›¾1çš„ä»£ç è¿›è¡Œä¸€ä¸‹æ”¹é€ ï¼Œè¿™æ ·ï¼Œç¨‹åºå°±èƒ½æ­£å¸¸è¿è¡Œäº†ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
let lock = NSRecursiveLock()
var recursiveMethod: ((Int) -> Void)! = nil
   
recursiveMethod = { value in
  
  defer {
      lock.unlock()
  }
  
  lock.lock()
  
  guard value > 0 else {
      return
  }
  
  print(value)
  sleep(2)
  recursiveMethod(value - 1)
}
   
DispatchQueue.global().async {
  
  print("start")
  recursiveMethod(5)
  print("end")
}

// è¾“å‡º
// start
// 5
// 4
// 3
// 2
// 1
// end
```

7.`__attribute__((noescape))å±æ€§`
----------

åœ¨Cocoaä¸­ï¼Œå¤§éƒ¨åˆ†APIçš„`closure/block`å‚æ•°éƒ½æ˜¯é€ƒé€¸çš„(`escaping`)ï¼Œå› æ­¤ï¼Œåœ¨swiftä¸­è°ƒç”¨Objective-Cçš„APIæ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åœ¨Objective-C APIä¸­çš„`closure/block`å‚æ•°å‰é¢æ·»åŠ `@escaping`ã€‚

åœ¨Objective-Cä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›`block`æ˜¯é€ƒé€¸çš„ï¼Œåˆ™å¯ä»¥åœ¨å‚æ•°å‰é¢æ·»åŠ `((noescape))`å±æ€§ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚å¦å¤–ä¹Ÿå¯ä»¥ç”¨ç³»ç»Ÿæä¾›çš„`NS_NOESCAPE/CF_NOESCAPE`å®ã€‚

```objc
// Handler.h
typedef void (^CompleteHandler)(void);

@interface Handler : NSObject

- (void)invokeBlockNow:(__attribute__((noescape)) CompleteHandler)blk;

- (void)invokeBlockLater:(NS_NOESCAPE CompleteHandler)blk;

@end

// Handler.m
@interface Handler ()

@property (nonatomic, strong) NSMutableSet *laterBlocks;

@end

@implementation Handler

- (void)invokeBlockNow:(CompleteHandler)blk {
    blk();
}

- (void)invokeBlockLater:(CompleteHandler)blk {
    if (self.laterBlocks == nil) {
        self.laterBlocks = [NSMutableSet set];
    }
    
    [self.laterBlocks addObject:blk];
    
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        NSSet *blocks = [self.laterBlocks copy];
        for (void (^blk)(void) in blocks) {
            blk();
        }
    });
}

@end
```

ä¸è¿‡åœ¨Xcode 8ä¸‹æµ‹è¯•äº†ä¸€ä¸‹ï¼Œç¼–è¯‘å™¨å¯¹è¿™ä¸ªå±æ€§è²Œä¼¼æ˜¯æ— æ„Ÿçš„ï¼Œåœ¨Siwftä¸­è°ƒç”¨ï¼Œæ— è®ºæœ‰æ²¡æœ‰åŠ `((noescape))`å±æ€§ï¼Œéƒ½ä¸ä¼šæœ‰é”™è¯¯æˆ–è­¦å‘Šæç¤ºï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
class HandlerCaller: NSObject {

    func call() {
        
        let handler = Handler()
        
        handler.invokeBlockNow { 
            print("invoke block now in swift")
        }
        
        handler.invokeBlockLater { 
            print("invoke block later in swift")
        }
    }
}
```

å¦å¤–ï¼Œå¯¹`C API`çš„å¤„ç†ä¹Ÿæ˜¯ç›¸åŒçš„ã€‚

å‚è€ƒ

1. [Make non-escaping closures the default](https://github.com/apple/swift-evolution/blob/master/proposals/0103-make-noescape-default.md)
2. [Add @noescape to public library API](https://github.com/apple/swift-evolution/blob/master/proposals/0012-add-noescape-to-public-library-api.md)

8.Swiftä¸­çš„escaping_closure
----------

åœ¨Swiftä¸­ä½¿ç”¨`@escaping`æ¥ä¿®é¥°ä¸€ä¸ªé€ƒé€¸é—­åŒ…(`Escaping Closures`)ï¼Œå³é—­åŒ…ä½œä¸ºå‚æ•°ä¼ åˆ°ä¸€ä¸ªå‡½æ•°ä¸­æ—¶ï¼Œè¿™ä¸ªé—­åŒ…å¯ä»¥ä¸åœ¨å‡½æ•°ä¸­è°ƒç”¨ï¼Œè€Œåœ¨å‡½æ•°è¿”å›ä¹‹åçš„æŸä¸ªæ—¶é—´å†è°ƒç”¨ã€‚å¦‚å¯ä»¥åœ¨å‡½æ•°ä¸­å°†é—­åŒ…èµ‹å€¼ç»™ä¸€ä¸ªç±»çš„æˆå‘˜å˜é‡ï¼Œæˆ–è€…ä¿å­˜åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œä»¥å¤‡åç»­å¼‚æ­¥è°ƒç”¨ã€‚è¿™ç±»é—­åŒ…å‚æ•°éœ€è¦ä½¿ç”¨`@escaping`æ¥ä¿®é¥°ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
var handlers: [(Int) -> Void] = []

func complete(handler: (Int) -> Void) {
    handlers.append(handler)	// error: passing non-escaping parameter 'handler' to function expecting an @escaping closure
}
```

éœ€è¦æ³¨æ„çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœåœ¨ç±»ä¸­ä½¿ç”¨é€ƒé€¸é—­åŒ…ï¼Œä¸”é—­åŒ…å†…è¦è°ƒç”¨å®ä¾‹å¯¹è±¡çš„å±æ€§æˆ–æ–¹æ³•æ—¶ï¼Œå¿…é¡»æ˜¾å¼åœ°å¼•ç”¨`self`ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
class A {
    
    var x = 10
    
    func testEscaping() {
        
        complete { (value) in
            print(value + x)		// error: reference to property 'x' in closure requires explicit 'self.' to make capture semantics explicit
        }
        
        handlers[0](10)
    }
}
```

Traits
----------

`Traits`æ˜¯ä¸€ä¸ªå¯ä»¥å®ç°å®æ—¶æ›´æ–°ä»£ç ï¼Œè€Œä¸éœ€è¦é‡æ–°è¿è¡Œç¨‹åºå°±å¯ä»¥çœ‹åˆ°æ•ˆæœçš„åº“ï¼Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæºç åœ°å€åœ¨[è¿™é‡Œ](https://github.com/krzysztofzablocki/Traits)ã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/09-1-1.gif?raw=true)

`Traits`ä¸»è¦æ˜¯ä¾èµ–äº`Injection`çš„ä»£ç æ³¨å…¥åŠŸèƒ½æ¥å®ç°å®æ—¶æ›´æ–°ã€‚å®ƒå¯ä»¥æ˜¯åœ¨ä»£ç ä¸­æ›´æ–°è§†å›¾å¯¹è±¡çš„å±æ€§ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ª`json`é…ç½®æ–‡ä»¶ç”šè‡³æ˜¯è¿œç¨‹çš„é…ç½®æ–‡ä»¶ä¸­å¤„ç†ï¼Œä¸”åšåˆ°å®æ—¶æ›´æ–°ã€‚å¯¹é…ç½®æ–‡ä»¶çš„å¤„ç†ï¼Œä¸»è¦ä¾èµ–äº`ObjectMapper`æ¥å®ç°`json`æ•°æ®ä¸å±æ€§çš„æ˜ å°„ï¼ŒåŒæ—¶å€ŸåŠ©`KZFileWatchers`åº“æ¥ç›‘å¬é…ç½®æ–‡ä»¶çš„æ›´æ–°ã€‚

ä¸è¿‡ä¸ªäººæ„Ÿè§‰æœ‰ä¸¤ç‚¹ç¨æ˜¾éº»çƒ¦ï¼š

1. éœ€è¦ä¸ºæ¯ä¸ªå±æ€§å®šä¹‰ä¸€ä¸ªç±»å¹¶ç»§æ‰¿`Trait`ç±»(ä¸åŒç±»çš„ç›¸åŒå±æ€§å¯ä»¥å®šä¹‰ä¸€ä¸ªç±»ï¼Œå¦‚`UILabel`å’Œ`UITextFiled`çš„`font`å±æ€§)ï¼Œå¦‚å›¾2ä»£ç æ‰€ç¤ºã€‚

	![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/09-1-2.png?raw=true)
	
2. åŒæ—¶éœ€è¦ä¸ºæ¯ä¸ªå…ƒç´ çš„æ¯ä¸ªå±æ€§éƒ½å®šä¹‰ä¸€ä¸ªæ ‡è¯†ï¼Œå¦‚å›¾3ä»£ç æ‰€ç¤ºã€‚ä¸è¿‡ä½œè€…æä¾›äº†ä¸€ä¸ªshellè„šæœ¬(generateTraitsIdentifiers.sh)æ¥å¤„ç†ã€‚
	
	![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/09-1-3.png?raw=true)

10.Injectionä»£ç æ³¨å…¥
----------

`Injection`æ˜¯johnnoå¼€å‘çš„ä¸€ä¸ª`Xcode`æ’ä»¶ï¼Œå…è®¸æˆ‘ä»¬å°†ä»£ç å®ç°æ›´å¿«æ³¨å…¥åˆ°æ¨¡æ‹Ÿå™¨è¿è¡Œçš„ç¨‹åºæˆ–macOSç¨‹åºã€‚åŸå…ˆå¯ä»¥é€šè¿‡`Alcatraz`å®‰è£…åˆ°Xcodeä¸­ï¼Œä¸è¿‡ç°åœ¨æ˜¯ç‹¬ç«‹çš„Appäº†ã€‚å¯ä»¥åœ¨[è¿™é‡Œ](http://johnholdsworth.com/Injection.app.zip)ä¸‹è½½å®‰è£…ã€‚å¯åŠ¨åä¼šå‡ºç°åœ¨å±å¹•é¡¶éƒ¨çš„å·¥å…·æ ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/10-1-1.png?raw=true)

è¦æ£€æµ‹æ˜¯å¦æœ‰æ•ˆï¼Œå¯ä»¥åœ¨æŸä¸ªç±»é‡Œé¢æ·»åŠ `injected`æ–¹æ³•ï¼Œç„¶åæ‰“ä¸ªæ–­ç‚¹ã€‚åœ¨ä»£ç ä¿®æ”¹åä¿å­˜ï¼Œç„¶åæ³¨å…¥ï¼Œå¦‚æœè¿›å…¥è¿™ä¸ªæ–­ç‚¹ï¼Œåˆ™è¯´æ˜å®‰è£…æˆåŠŸï¼ŒåŒæ—¶æ§åˆ¶å™¨ä¼šæœ‰ç›¸åº”ä¿¡æ¯è¾“å‡ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/10-1-2.png?raw=true)

`Injection`ä½¿ç”¨`AppleScript`æ¥å’ŒXcodeè¿›è¡Œé€šä¿¡ï¼Œä»¥ç¡®å®šå½“å‰çš„æ–‡ä»¶ä¸å·¥ç¨‹ï¼Œç„¶åå°†ä»£ç æ³¨å…¥åˆ°æ¨¡æ‹Ÿå™¨ï¼Œå†åŠ è½½æ–°ä»£ç ï¼Œå¹¶å°†æ–°ä»£ç æ›¿æ¢åŸæ¥çš„ä»£ç ã€‚å…¶æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/10-1-3.gif?raw=true)

`Injection`ç¨‹åºè¿˜åŒ…å«ä¸€ä¸ª`Xprobe`æµè§ˆå™¨ï¼Œç”¨äºæŸ¥çœ‹ç¨‹åºçš„å†…å­˜ã€‚å¯ä»¥é€‰æ‹©å›¾1ä¸­çš„`Load Xprobe`èœå•é¡¹ï¼Œå¼¹å‡ºçš„çª—å£ä¸­æ˜¾ç¤ºäº†å½“å‰æ—¶é—´ç‚¹çš„å¯¹è±¡å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™åšä¸€äº›æœ‰æ„æ€çš„äº‹æƒ…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/10-1-4.png?raw=true)

[Injectionå·¥ç¨‹æºç ](https://github.com/johnno1962/injectionforxcode)

[æ–‡æ¡£](https://johntmcintosh.com/blog/2016/10/03/code-injection-ios)


11.è·¯å¾„å¡«å……è§„åˆ™
----------

Quartzåœ¨å¡«å……åŒºåŸŸæ—¶æœ‰ä¸¤å¥—è§„åˆ™ï¼š`éé›¶ç¼ ç»•æ•°è§„åˆ™(nonzero windingnumber rule)`å’Œ`å¶æ•°-å¥‡æ•°è§„åˆ™(Even-odd)`ã€‚

1. **éé›¶ç¼ ç»•æ•°è§„åˆ™**ï¼šä¸ºäº†ç¡®å®šä¸€ä¸ªç‚¹æ˜¯å¦éœ€è¦ç»˜åˆ¶ï¼Œæˆ‘ä»¬ä»è¯¥ç‚¹å¼€å§‹ç»˜åˆ¶ä¸€æ¡ç›´çº¿ç©¿è¿‡ç»˜å›¾çš„è¾¹ç•Œã€‚ä»0å¼€å§‹è®¡æ•°ï¼Œæ¯æ¬¡è·¯å¾„ç‰‡æ–­ä»å·¦åˆ°å³ç©¿è¿‡ç›´çº¿æ—¶ï¼Œè®¡æ•°åŠ 1ï¼›è€Œä»å³åˆ°å·¦ç©¿è¿‡ç›´çº¿æ—¶ï¼Œè®¡æ•°å‡1ã€‚å¦‚æœç»“æœä¸º0ï¼Œåˆ™ä¸ç»˜åˆ¶è¯¥ç‚¹ï¼Œå¦åˆ™ç»˜åˆ¶ã€‚æ³¨æ„è¿™ç§è§„åˆ™ä¸‹ï¼Œè·¯å¾„ç‰‡æ–­ç»˜åˆ¶çš„æ–¹å‘ä¼šå½±å“åˆ°ç»“æœã€‚

2. **å¶æ•°-å¥‡æ•°è§„åˆ™**ï¼šä¸ºäº†ç¡®å®šä¸€ä¸ªç‚¹æ˜¯å¦è¢«ç»˜åˆ¶ï¼Œæˆ‘ä»¬ä»è¯¥ç‚¹å¼€å§‹ç»˜åˆ¶ä¸€æ¡ç›´çº¿ç©¿è¿‡ç»˜å›¾çš„è¾¹ç•Œã€‚è®¡ç®—ç©¿è¿‡è¯¥ç›´çº¿çš„è·¯å¾„ç‰‡æ–­çš„æ•°ç›®ã€‚å¦‚æœæ˜¯å¥‡æ•°ï¼Œåˆ™ç»˜åˆ¶è¯¥ç‚¹ï¼Œå¦‚æœæ˜¯å¶æ•°ï¼Œåˆ™ä¸ç»˜åˆ¶è¯¥ç‚¹ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè·¯å¾„ç‰‡æ–­ç»˜åˆ¶çš„æ–¹å‘ä¸å½±å“ç»“æœã€‚

å®˜æ–¹æ–‡æ¡£ç»™å‡ºäº†ä¸‹å›¾æ¥æ¼”ç¤ºä¸¤ç§è§„åˆ™çš„æ•ˆæœã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/11-1-1.gif?raw=true)

ä¸è¿‡ä»Šå¤©æµ‹è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°ä¸æ–‡æ¡£æœ‰å‡ºå…¥ï¼Œå¯èƒ½æ˜¯ç†è§£ä¸å¯¹ã€‚ç»˜åˆ¶ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/11-1-2.png?raw=true)

æµ‹è¯•ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/11-1-3.png?raw=true)

ç»˜åˆ¶ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/11-1-4.png?raw=true)

å¡«å……è§„åˆ™é™¤äº†è¿™ä¸¤ç§ï¼Œè¿˜æœ‰`Positive`å’Œ`Negative`ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸€ä¸‹ã€‚ 

å‚è€ƒ

1. [Nonzero-rule](https://en.wikipedia.org/wiki/Nonzero-rule)
2. [Evenâ€“odd rule](https://en.wikipedia.org/wiki/Even%E2%80%93odd_rule)
3. [Quartz 2Dç¼–ç¨‹æŒ‡å—ä¹‹ä¸‰ï¼šè·¯å¾„(Path)](http://southpeak.github.io/2014/11/16/quartz2d-3/)
4. [PolyFillType](http://www.angusj.com/delphi/clipper/documentation/Docs/Units/ClipperLib/Types/PolyFillType.htm)

12.filterä¸flatMapè¿‡æ»¤nil
----------

ä½¿ç”¨é«˜é˜¶å‡½æ•°è¿‡æ»¤ä¸€ä¸ªæ•°ç»„ä¸­çš„nilå¯ä»¥æœ‰ä¸¤ç§æ–¹æ³•ï¼š`filter`å’Œ`flatMap`ã€‚

`filter`æ–¹æ³•å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
let array: [Int?] = [1, 2, 3, 5, nil, 9]

let result = array.filter { element in
    element != nil
}

print(result)		// [Optional(1), Optional(2), Optional(3), Optional(5), Optional(9)]
```

`flatMap`æ–¹æ³•å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
let array: [Int?] = [1, 2, 3, 5, nil, 9]
let result: [Int] = array.flatMap {
    $0
}

print(result)		// [1, 2, 3, 5, 9]
```

ä»è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œ`filter`è¿”å›çš„ä»ç„¶æ˜¯ä¸€ä¸ª`Optional`æ•°ç»„ï¼Œè€Œ`flatMap`è¿”å›çš„æ˜¯ä¸€ä¸ªé`Optional`æ•°ç»„ã€‚ä¸€èˆ¬æ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚

13.NSRecursiveLock.lock(before:)
----------

`NSRecursiveLock`é€’å½’é”æä¾›äº†ä¸€ä¸ªæ–¹æ³•`lock(before:)`ï¼Œç”¨äºåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œå»å°è¯•è¯·æ±‚ä¸€ä¸ªé€’å½’é”ï¼Œç„¶åæ ¹æ®è¿”å›çš„å¸ƒå°”å€¼ï¼Œæ¥åšç›¸åº”çš„å¤„ç†ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œæ˜¯ä¸€ä¸ªæ­£å¸¸çš„é€’å½’é”è°ƒç”¨è¿‡ç¨‹ï¼š

```swift
let lock = NSRecursiveLock()
var recursiveMethod: ((Int) -> Void)! = nil
   
recursiveMethod = { value in
  
  defer {
      lock.unlock()
  }
  
  lock.lock()
  
  guard value > 0 else {
      return
  }
  
  print(value)
  sleep(2)
  recursiveMethod(value - 1)
}
   
DispatchQueue.global().async {
  
  print("start")
  recursiveMethod(5)
  print("end")
}
```

åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¦èµ·ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”å°è¯•å»è·å–è¿™ä¸ªé€’å½’é”ï¼Œåˆ™å¯ä»¥å¦‚ä¸‹ä»£ç å¤„ç†ï¼š

```swift
DispatchQueue.global().async {
  sleep(2)
  
  let flag = lock.lock(before: Date(timeIntervalSinceNow: 1))
  if flag {
      print("lock before date")
      lock.unlock()
  } else {
      print("fail to lock before date")
  }
}
```

å½“ç„¶è¿™ç§æƒ…å†µä¸‹ä¼šå¤±è´¥ï¼Œå…¶è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºã€‚å¦‚æœå°†`lock(before:)`ä¸­çš„æ—¶é—´è®¾ç½®é•¿ä¸€ç‚¹ï¼Œåˆ™ä¼šæ‰“å°å‡º"lock befor date"ã€‚

14.Swift3ç§»é™¤Optionalç±»å‹çš„æ¯”è¾ƒæ“ä½œ
----------

`Swift 3`å·²ç»ç§»é™¤äº†`Optional`ç±»å‹çš„æ¯”è¾ƒæ“ä½œï¼Œè¿™åœ¨[Swift evolution SE-0121: Remove Optional Comparison Operators](https://github.com/apple/swift-evolution/blob/master/proposals/0121-remove-optional-comparison-operators.md)è¿™æ¡ä¸­æ˜ç¡®äº†è¿™ä¸€ç‚¹ã€‚

åœ¨`Swift 3`ä¹‹å‰ï¼Œæ ‡å‡†åº“å®šä¹‰äº†4ä¸ªæ“ä½œç¬¦ä»¥æ”¯æŒ`Optional`ç±»å‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/14-1-1.png?raw=true)

ä¸è¿‡`Swift 3`ä¸­ï¼Œç”±äºæ³›å‹ä¸æ”¯æŒæ¡ä»¶ä¸€è‡´æ€§åˆ¤æ–­ï¼Œå³æ²¡æœ‰é€šç”¨çš„æ–¹æ³•æ¥å®šä¹‰åœ¨æ¯”è¾ƒnilå’Œénilå€¼æ—¶ï¼Œåº”è¯¥å¾—åˆ°æ€æ ·çš„å€¼ï¼Œæ‰€ä»¥å®é™…ç»“æœå¯èƒ½ä¸æ˜¯é¢„æœŸçš„ã€‚æ‰€ä»¥ï¼Œåœ¨`Swift 3`ä¸­ï¼Œå¦‚æœå»æ¯”è¾ƒä¸¤ä¸ª`Optional`å€¼ï¼Œä¼šç»™å‡ºç¼–è¯‘é”™è¯¯ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚è€Œè¿™ä¸€æ¯”è¾ƒåœ¨Swift 3ä¹‹å‰æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚

```swift
let dic1 = [
    "first": "123",
    "last": "234"
]

let dic2 = [
    "first": "123",
    "last": "968"
]

dic1["middle"] < dic2["middle"]		// value of optional type 'String?' not unwrapped; did you mean to use '!' or '?'?
```

å½“ç„¶åœ¨SE-0121ä¸­ä¹Ÿè¯´äº†ï¼Œç­‰æ³›å‹æ›´åŠ æˆç†Ÿåï¼Œä¸æ’é™¤ä¼šå°†è¿™ä¸€ç‰¹æ€§å†æ·»åŠ å›æ¥ã€‚

15.`__attribute__((objc_requires_super))`
----------

Objective-Cå…è®¸å­ç±»å¯ä»¥é‡å†™çˆ¶ç±»çš„æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›å­ç±»æ–¹æ³•é‡å†™çˆ¶ç±»æ–¹æ³•æ—¶å¿…é¡»ä½¿ç”¨superæ¥è°ƒç”¨çˆ¶ç±»çš„å¯¹åº”æ–¹æ³•ï¼Œåˆ™å¯ä»¥åœ¨æ–¹æ³•å£°æ˜åé¢æ·»åŠ clangçš„ç¼–è¯‘å±æ€§`objc_requires_super`ã€‚æ·»åŠ è¿™ä¸€å±æ€§åï¼Œå¦‚æœå­ç±»æ²¡æœ‰è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œåˆ™ä¼šç»™å‡ºä¸€ä¸ªç¼–è¯‘è­¦å‘Šï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```objc
@interface Bird : NSObject

- (void)fly __attribute__((objc_requires_super));

@end

@implementation Bird

- (void)fly {
    NSLog(@"Bird Fly");
}

@end


@interface Eagle : Bird

@end

@implementation Eagle

- (void)fly {
    
}		// Method possibly missing a [super fly] call

@end
```

è¿™ä¸ªå±æ€§åªèƒ½ç”¨è®°ç±»ä¸­çš„æ–¹æ³•å£°æ˜ï¼Œè€Œä¸èƒ½ç”¨äºåè®®ã€‚å¦å¤–ï¼Œ`Foundation`æä¾›äº†ä¸€ä¸ªå¯¹åº”çš„å®`NS_REQUIRES_SUPER`ï¼Œå®šä¹‰å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```objc
#ifndef NS_REQUIRES_SUPER
#if __has_attribute(objc_requires_super)
#define NS_REQUIRES_SUPER __attribute__((objc_requires_super))
#else
#define NS_REQUIRES_SUPER
#endif
#endif
```

å‚è€ƒ

1. [Attributes in Clang](http://clang.llvm.org/docs/AttributeReference.html#objc-requires-super)

16.`__attribute__((objc_runtime_name))`
----------

`Objective-C`åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯å°†ç±»æˆ–åè®®çš„åå­—ä½œä¸ºå…ƒæ•°æ®åç§°(`metadata name`)ï¼Œå³å¦‚æœæˆ‘ä»¬æ‰“å°ä¸€ä¸ªå¯¹è±¡çš„`class`æ–¹æ³•ï¼Œè¾“å‡ºå°±æ˜¯å¯¹è±¡æ‰€å±ç±»çš„ç±»åï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/16-1-1.png?raw=true)

å¦‚æœæˆ‘ä»¬æƒ³ä¸ºç±»æˆ–åè®®æŒ‡å®šä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸ºå…¶å…ƒæ•°æ®åç§°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ç¼–è¯‘å±æ€§`objc_runtime_name`ï¼Œå¦‚ä¸‹å›¾ä»£ç æ‰€ç¤ºï¼Œåªéœ€è¦åœ¨ç±»æˆ–åè®®å£°æ˜ä¹‹å‰åŠ ä¸Š`__attribute__((objc_runtime_name("identifier")))`ã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/16-1-2.png?raw=true)

å‚è€ƒ

1. [Clang 5 documentation](http://clang.llvm.org/docs/AttributeReference.html#objc-runtime-name)
2. [Clang Attributes é»‘é­”æ³•å°è®°](http://blog.sunnyxx.com/2016/05/14/clang-attributes/)

17.Tagged_Pointer
----------

è‹¹æœåœ¨64ä½ARMæ¶æ„ä¸‹ï¼Œå¯¹`NSNumber`ç­‰å°å¯¹è±¡å¯¹è±¡çš„å­˜å‚¨åšäº†ä¼˜åŒ–ï¼Œå³ä½¿ç”¨`Tagged Pointer`æŠ€æœ¯ã€‚é€šè¿‡ä½¿ç”¨è¿™ç§æŠ€æœ¯ï¼Œ`NSNumber`æŒ‡é’ˆå˜é‡æŒ‡å‘çš„å€¼ä¸å†æ˜¯å•ç‹¬å­˜å‚¨åœ¨ä¸€å—å†…å­˜ä¸­ï¼Œè€Œæ˜¯å¯¹æŒ‡é’ˆæœ¬èº«åšäº†ç‰¹æ®Šå¤„ç†ï¼Œå¦‚ä¸‹å›¾ä»£ç æ‰€ç¤ºã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/17-1-1.png?raw=true)

å¯ä»¥çœ‹åˆ°è¿™äº›æŒ‡é’ˆä¸€éƒ¨åˆ†ç›´æ¥ä¿å­˜æ•°æ®(å¦‚ä¸‹å›¾è“è‰²éƒ¨åˆ†)ï¼Œå¦ä¸€éƒ¨åˆ†ä½œä¸ºç‰¹æ®Šæ ‡è®°(å¦‚å›¾2çº¢è‰²éƒ¨åˆ†)ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸ªç‰¹æ®ŠæŒ‡é’ˆï¼Œä¸æŒ‡å‘ä»»ä½•åœ°å€ã€‚è¿™ä¹ˆåšå¤§å¤§å‡å°‘äº†è¿™ç±»å€¼çš„å­˜å‚¨ç©ºé—´ï¼ŒåŒæ—¶æé«˜äº†å®ƒä»¬çš„åˆ›å»ºåŠè¯»å–æ•ˆç‡ã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/17-1-2.png?raw=true)

å½“ç„¶ï¼Œå¦‚æœæ•°æ®å­˜å‚¨éƒ¨åˆ†(7ä¸ªå­—èŠ‚)æ— æ³•å®¹çº³ä¸‹å˜é‡çš„å€¼ï¼Œåˆ™ä¼šæŒ‰åŸå§‹çš„æ–¹å¼ï¼Œå¦è¾Ÿç©ºé—´å»å­˜å‚¨å€¼ï¼ŒæŒ‡é’ˆçš„å€¼ä»ç„¶æ˜¯æŒ‡å‘è¿™ä¸ªç©ºé—´çš„åœ°å€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/17-1-3.png?raw=true)

å‚è€ƒ

1. [æ·±å…¥ç†è§£Tagged Pointer](http://www.infoq.com/cn/articles/deep-understanding-of-tagged-pointer)
2. [WWDC 2013 Advanced in Objective-C](https://developer.apple.com/videos/play/wwdc2013/404/)

18.Extension_Selector
----------

åœ¨`Swift`ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`#selector`è®¾ç½®`target-action`æ¨¡å¼ä¸­çš„`action`æ“ä½œï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
class ViewController: UIViewController {

    override func viewDidLoad() {
        super.viewDidLoad()
        
        let button = UIButton(type: .custom)
        button.addTarget(self, action: #selector(buttonTapped), for: .touchUpInside)
        
        view.addSubview(button)
    }

    func buttonTapped() {
        
    }
}
```

å¦‚æœä½ æœ‰ä»£ç æ´ç™–ï¼Œæƒ³æŠŠ`#selector`é›†ä¸­èµ·æ¥ç®¡ç†ï¼Œåˆ™å¯ä»¥å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œæ¥ç»Ÿä¸€å½’é›†è¿™æ ·çš„ä»£ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™æ ·çœ‹ç€æ˜¯ä¸æ˜¯ä¼šæ›´æ•´æ´ä¸€äº›ï¼Ÿ

![](https://github.com/southpeak/iOS-tech-set/blob/master/images/2017/01/21-1-1.png?raw=true)

ä¸è¿‡ï¼Œè¿˜æœ‰ç§æ›´å¥½çš„æ–¹å¼ï¼Œå°±æ˜¯ç›´æ¥æ‰©å±•`Selector`ç»“æ„ä½“ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œè¿™æ ·å¯ä»¥åœ¨ä½¿ç”¨æ—¶ç›´æ¥ç”¨`.buttonTapped`è¿™ç§æ–¹å¼æ¥å¼•ç”¨ï¼Œå°±åƒæˆ‘ä»¬ä½¿ç”¨`.red`è¿™æ ·çš„`UIColor`å±æ€§ä¸€æ ·ç®€æ´ã€‚

```swift
extension Selector {
    static let buttonTapped = #selector(ViewController.buttonTapped)
}

class ViewController: UIViewController {

    override func viewDidLoad() {
        super.viewDidLoad()
        
        let button = UIButton(type: .custom)
        button.addTarget(self, action: .buttonTapped, for: .touchUpInside)
        
        view.addSubview(button)
    }

    func buttonTapped() {
        
    }
}
```

å‚è€ƒ

[Swift: Selector Syntax Sugar](https://medium.com/swift-programming/swift-selector-syntax-sugar-81c8a8b10df3#.md6860mmq)


19.typealiasæ³›å‹é—­åŒ…
----------

åœ¨`Swift`ä¸­æˆ‘ä»¬å¯ä»¥ç”¨`typealias`æ¥ä¸ºå·²ç»å­˜åœ¨çš„ç±»å‹é‡æ–°å®šä¹‰åå­—çš„,é€šè¿‡å‘½åå¯ä»¥ä½¿ä»£ç å˜å¾—æ›´åŠ æ¸…æ™°ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ç»™é—­åŒ…ç±»å‹å®šä¹‰ä¸€ä¸ªæ–°åå­—ï¼Œç»™å¸¦æœ‰æ³›å‹çš„é—­åŒ…é‡æ–°å®šä¹‰åå­—çš„æ–¹å¼å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
typealias Block<U> = (U, U) -> Bool

func compare<T: Comparable>(number1: T, number2: T, algorithm: Block<T>) -> Bool {
    return algorithm(number1, number2)
}

compare(number1: 10, number2: 20) {
    $0 < $1
}
```

20.Swift3çš„#keyPath
----------

åœ¨`Objective-C/Swift`ä¸­ä½¿ç”¨`KVC`æˆ–`KVO`æ€»æ˜¯éœ€è¦æ ¼å¤–å°å¿ƒï¼Œå› ä¸ºå¯¹äº`key`æˆ–`keyPath`ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å­—ç¬¦ä¸²å­—é¢é‡æ¥å¤„ç†ã€‚è¿™æ ·åœ¨ç¼–è¯‘æœŸæ— æ³•æ£€æµ‹æˆ‘ä»¬çš„è¾“å…¥æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è®¸æˆ‘ä»¬ä¼šå› ä¸ºä¸€æ—¶å¤§æ„ï¼Œå¤šå†™äº†æˆ–å°‘å†™äº†ä¸€ä¸ªå­—ç¬¦ï¼Œæˆ–æ‹¼é”™äº†å•è¯ã€‚è€Œè¿™ä¸ªé”™è¯¯åªèƒ½åœ¨è¿è¡Œæ—¶ï¼Œç¨‹åºå´©æºƒæ—¶æ‰èƒ½å‘ç°ï¼Œå¾ˆä¸çˆ½çš„å§ã€‚

ä¸ºæ­¤ï¼Œåœ¨`Swift 3`ä¸­å¼•å…¥äº†`#keyPath()`è¿™ä¸ªè¡¨è¾¾å¼ï¼Œå®ƒæ¥æ”¶`Object.property`å½¢å¼çš„å‚æ•°ï¼Œå¹¶å°†å…¶è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚å› ä¸ºä½¿ç”¨çš„æ˜¯å¯¹è±¡å’Œå±æ€§çš„æ–¹å¼ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨èƒ½å»æ£€æµ‹è¿™ä¸ªè¡¨è¾¾å¼æ˜¯å¦æœ‰æ•ˆï¼Œä»è€Œé¿å…äº†ä¸Šé¢çš„é—®é¢˜ã€‚

```swift
class Person: NSObject {
    dynamic var firstName: String = ""
    
    init(firstName: String) {
        self.firstName = firstName
    }
}

let chris = Person(firstName: "Chris")


#keyPath(Person.firstName) // => "firstName"
chris.value(forKeyPath: #keyPath(Person.firstName))
```

å‚è€ƒ

1. [Referencing Objective-C key-paths](https://github.com/apple/swift-evolution/blob/master/proposals/0062-objc-keypaths.md)

21.Swift3ç§»é™¤varå…³é”®å­—
----------

`Swift 3`ä¸­ç§»é™¤äº†å‡½æ•°å‚æ•°ä¸­çš„`var`å…³é”®å­—ï¼Œ[swift proposals SE-0003](https://github.com/apple/swift-evolution/blob/master/proposals/0003-remove-var-parameters.md)ä¸­çš„è§‚ç‚¹æ˜¯`var`æ ‡è®°çš„å‚æ•°åªæ˜¯æœ¬åœ°å¤æœ¬ä¼šå˜åŒ–ï¼Œä¸ä¼šå›ä¼ ç»™åŸå§‹å€¼ï¼Œå› æ­¤è°ƒç”¨è€…å¹¶ä¸ä¼šçŸ¥é“å‚æ•°å€¼çš„æ”¹å˜ï¼Œå®é™…ä¸Šæ²¡æœ‰å¤ªå¤§çš„å®ç”¨æ€§ã€‚

ç§»é™¤`var`ä¸»è¦æœ‰å‡ ä¸ªåŸå› ï¼š

1. `var`å®¹æ˜“ä¸`inout`æ··æ·†ï¼›
2. `var`ç»å¸¸è¢«æ··æ·†ï¼Œä»¥ä½¿å€¼ç±»å‹å…·æœ‰å¼•ç”¨è¯­ä¹‰ï¼›
3. å‡½æ•°å‚æ•°é€šå¸¸æ˜¯ä¸å¯é‡ç”¨çš„

å‚è€ƒ

1. [Removing var from Function Parameters](https://github.com/apple/swift-evolution/blob/master/proposals/0003-remove-var-parameters.md)

22.Swift3ä¸­çš„AnyHashable
----------

åœ¨`Swift 3`çš„æ ‡å‡†åº“ä¸­æ·»åŠ äº†`AnyHashable`è¿™ä¸€æ–°ç±»å‹ï¼Œå…¶ç”¨é€”æ˜¯åœ¨éœ€è¦`Hash`å€¼çš„é›†åˆä¸­ï¼Œå¯ä»¥æ··åˆä½¿ç”¨å¤šç§`Hashable`ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå­—å…¸çš„`key`å€¼ï¼Œå…¶è¦æ±‚æ˜¯`Hashable`ç±»å‹ï¼Œå¦‚æœå¸Œæœ›`key`å€¼æ˜¯ä»»æ„å®ç°äº†`Hashable`åè®®çš„ç±»å‹ï¼Œåˆ™åœ¨å£°æ˜å­—å…¸æ—¶ï¼Œå¯ä»¥ä½¿ç”¨`AnyHashable`ä½œä¸º`key`çš„ç±»å‹ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```swift
let description: [AnyHashable: Any] = [
    AnyHashable("ğŸ˜„"): "emoji",
    AnyHashable(42): "an Int",
    AnyHashable(34.2): "a Double",
    AnyHashable(Set(["a", "b"])): "a set of strings"
]

print(description[AnyHashable(42)]!)        // an Int
print(description[AnyHashable(34)])         // nil
print(description[AnyHashable(Set(["a", "b"]))]!)   // a set of strings
```

æ—©å…ˆï¼Œåœ¨`ObjC`ä¸`Swift`æ··åˆç¼–ç¨‹ä¸­ï¼Œ`ObjC`çš„`NSDictionary`å¯¼å…¥åˆ°`Swift`æ—¶ï¼Œæ˜¯è½¬æ¢æˆ`[NSObject: AnyObject]`ç±»å‹ã€‚ä½¿ç”¨`NSObject`ä½œä¸º`key`çš„ç±»å‹ï¼Œå› ä¸º`NSObject`æ˜¯æœ€æ¥è¿‘äº`AnyObject`ä¸”å®ç°äº†`Hashable`çš„ç±»å‹ã€‚ä¸è¿‡`Swift`å¸Œæœ›åœ¨æ ‡å‡†åº“ä¸­é™åˆ¶`AnyObject`çš„ä½¿ç”¨ï¼Œè€Œæ›´å¤šçš„ä½¿ç”¨`Any`ï¼Œæ‰€ä»¥åŠ å…¥äº†`AnyHashable`ç±»å‹ã€‚

å‚è€ƒ

1. [Add AnyHashable to the standard library](https://github.com/apple/swift-evolution/blob/master/proposals/0131-anyhashable.md)





